<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>週間スケジュール</title>
    <style>
      .week-schedule {
        display: flex;
        justify-content: space-between;
        margin-top: 50px;
      }
      .day {
        width: 14%;
        border: 1px solid #000;
        background-color: #030303;
        min-height: 600px;
        position: relative;
      }
      .activity {
        padding: 10px;
        margin: 5px;
        color: #000000;
        border: 2px solid #ffffff;
        font-size: 14px;
        text-align: center;
        border-radius: 5px;
        cursor: move;
      }
      .outside-activities {
        display: flex;
        flex-wrap: wrap;
        margin-top: 20px;
      }
      #activity-code {
        position: fixed;
        bottom: 10px;
        right: 10px;
        border: 1px solid #000;
        padding: 10px;
        background-color: #f1f1f1;
      }
      h3 {
        color: #ffffff;
      }
    </style>
  </head>
  <body>
    <div class="outside-activities">
      <div
        class="activity"
        style="background-color: #c79696"
        draggable="true"
        id="A01"
      >
        植菌準備
      </div>
      <div
        class="activity"
        style="background-color: #85cf85"
        draggable="true"
        id="A02"
      >
        収穫
      </div>
      <div
        class="activity"
        style="background-color: #8cadd3"
        draggable="true"
        id="A03"
      >
        水源整備
      </div>
      <div
        class="activity"
        style="background-color: #c79696"
        draggable="true"
        id="A04"
      >
        袋詰め
      </div>
      <div
        class="activity"
        style="background-color: #c79696"
        draggable="true"
        id="A05"
      >
        植菌
      </div>
      <div
        class="activity"
        style="background-color: #c79696"
        draggable="true"
        id="A06"
      >
        点火・窯出し
      </div>
      <div
        class="activity"
        style="background-color: #c79696"
        draggable="true"
        id="A07"
      >
        栄養体準備
      </div>
      <div
        class="activity"
        style="background-color: #85cf85"
        draggable="true"
        id="A08"
      >
        菌床洗い
      </div>
      <div
        class="activity"
        style="background-color: #85cf85"
        draggable="true"
        id="A09"
      >
        菌床移動
      </div>
      <div
        class="activity"
        style="background-color: #85cf85"
        draggable="true"
        id="A10"
      >
        除袋
      </div>
      <div
        class="activity"
        style="background-color: #8cadd3"
        draggable="true"
        id="A11"
      >
        浸水出す
      </div>
      <div
        class="activity"
        style="background-color: #8cadd3"
        draggable="true"
        id="A12"
      >
        浸水入れる
      </div>
      <div
        class="activity"
        style="background-color: #8cadd3"
        draggable="true"
        id="A13"
      >
        菌床廃棄
      </div>
      <div
        class="activity"
        style="background-color: #e0d860"
        draggable="true"
        id="A14"
      >
        商品準備
      </div>
      <div
        class="activity"
        style="background-color: #e0d860"
        draggable="true"
        id="A15"
      >
        ﾊﾟｯｸ詰め
      </div>
      <div
        class="activity"
        style="background-color: #e0d860"
        draggable="true"
        id="A16"
      >
        出荷
      </div>
    </div>

    <div class="week-schedule">
      <div
        class="day"
        data-day="MON"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h3>月曜日</h3>
      </div>
      <div
        class="day"
        data-day="TUE"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h3>火曜日</h3>
      </div>
      <div
        class="day"
        data-day="WED"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h3>水曜日</h3>
      </div>
      <div
        class="day"
        data-day="THU"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h3>木曜日</h3>
      </div>
      <div
        class="day"
        data-day="FRI"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h3>金曜日</h3>
      </div>
      <div
        class="day"
        data-day="SAT"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h3>土曜日</h3>
      </div>
      <div
        class="day"
        data-day="SUN"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h3>日曜日</h3>
      </div>
    </div>

    <div id="activity-code">
      アクティビティコード: <span id="code-output"></span>
    </div>

    <script>
      function allowDrop(event) {
        event.preventDefault();
      }

      function drag(event) {
        event.dataTransfer.setData("text/plain", event.target.outerHTML);
      }

      function drop(event) {
        event.preventDefault();
        const data = event.dataTransfer.getData("text/plain");
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = data;

        const activity = tempDiv.firstChild;
        activity.removeAttribute("id");

        const dayElement = event.target.closest(".day");
        if (dayElement) {
          dayElement.appendChild(activity);
          updateActivityCode(); // アクティビティコード更新
        }

        addDragEvents(activity);
      }

      // アクティビティの移動、削除機能を有効にする
      function addDragEvents(activity) {
        activity.addEventListener("dragstart", drag);

        // ダブルクリックで削除
        activity.addEventListener("dblclick", () => {
          activity.remove();
          updateActivityCode(); // アクティビティコード更新
        });

        // 右クリックで上下移動（シンプルな実装）
        activity.addEventListener("contextmenu", (event) => {
          event.preventDefault();

          if (event.shiftKey && activity.previousElementSibling) {
            activity.parentNode.insertBefore(
              activity,
              activity.previousElementSibling
            );
          } else if (!event.shiftKey && activity.nextElementSibling) {
            activity.parentNode.insertBefore(
              activity.nextElementSibling,
              activity
            );
          }

          updateActivityCode(); // アクティビティコード更新
        });
      }

      // 初期アクティビティにドラッグイベントを追加
      document.querySelectorAll(".activity").forEach((item) => {
        addDragEvents(item);
      });

      // アクティビティコードの更新
      function updateActivityCode() {
        let code = "";
        document.querySelectorAll(".day").forEach((day) => {
          const dayCode = day.getAttribute("data-day");
          day.querySelectorAll(".activity").forEach((activity) => {
            const activityText = activity.textContent.trim();
            if (activityText === "アクティビティ1") {
              code += dayCode + "A01";
            } else if (activityText === "アクティビティ2") {
              code += dayCode + "A02";
            } else if (activityText === "アクティビティ3") {
              code += dayCode + "A03";
            }
          });
        });
        document.getElementById("code-output").textContent = code;
      }

      // 配置に基づいてアクティビティを表示
      function setActivityFromCode(code) {
        document.querySelectorAll(".day").forEach((day) => {
          // 各日のアクティビティをクリア
          while (day.firstChild && day.firstChild.tagName !== "H3") {
            day.removeChild(day.firstChild);
          }
        });

        for (let i = 0; i < code.length; i += 5) {
          const dayCode = code.substring(i, i + 3);
          const activityCode = code.substring(i + 3, i + 5);

          console.log(`dayCode: ${dayCode}, activityCode: ${activityCode}`); // デバッグ用ログ

          const dayElement = document.querySelector(
            `.day[data-day="${dayCode}"]`
          );
          if (!dayElement) {
            console.log(`dayElement not found for dayCode: ${dayCode}`);
            continue; // dayElement が null の場合、次に進む
          }

          const newActivity = document.createElement("div");
          newActivity.classList.add("activity");
          newActivity.setAttribute("draggable", "true");

          // アクティビティコードに基づいてテキストと色を設定
          if (activityCode === "A01") {
            newActivity.style.backgroundColor = "#ff0000";
            newActivity.textContent = "アクティビティ1";
          } else if (activityCode === "A02") {
            newActivity.style.backgroundColor = "#00ff00";
            newActivity.textContent = "アクティビティ2";
          } else if (activityCode === "A03") {
            newActivity.style.backgroundColor = "#0000ff";
            newActivity.textContent = "アクティビティ3";
          }

          console.log(`Appending activity to day: ${dayCode}`); // デバッグ用ログ
          dayElement.appendChild(newActivity);
          addDragEvents(newActivity);
        }
        updateActivityCode(); // コードを更新
      }

      // デモのためのサンプルコード設定
      const demoCode = "MONA01TUEA02WEDA03";
      setActivityFromCode(demoCode);
    </script>
  </body>
</html>
